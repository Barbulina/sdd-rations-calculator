# Phase 1: Data Model - Custom Aliment Creation

**Feature**: 003-aliment-catalog  
**Phase**: Design - Data Model  
**Date**: 2026-02-12

## Entities

### CustomAliment

Extends the existing `AlimentInfo` interface to add persistence and identification fields for user-created aliments.

```typescript
interface CustomAliment extends AlimentInfo {
  id: string;              // UUID generated by repository
  createdAt: Date;         // Timestamp of creation
  isCustom: true;          // Type discriminator (literal type)
  updatedAt?: Date;        // Optional: Last modification timestamp
}
```

**Fields**:

| Field | Type | Required | Validation | Source |
|-------|------|----------|------------|--------|
| `id` | string | Yes | UUID v4 format | Generated by repository using `crypto.randomUUID()` |
| `name` | string | Yes | 1-200 chars, trimmed | From AlimentInfo, user input |
| `type` | RationsType | Yes | One of 7 enum values | From AlimentInfo, user selection |
| `gramsToCarbohydrate` | number | Yes | > 0 | From AlimentInfo, user input |
| `bloodGlucoseIndex` | number | No | 0-100 or undefined | From AlimentInfo, user input |
| `createdAt` | Date | Yes | Valid Date object | Generated by repository |
| `isCustom` | true | Yes | Literal type `true` | Set by repository |
| `updatedAt` | Date | No | Valid Date, > createdAt | Set on updates only |

**Validation Rules**:
- `name`: Must be non-empty after trim, max 200 characters
- `gramsToCarbohydrate`: Must be positive number
- `bloodGlucoseIndex`: If provided, must be 0-100
- `type`: Must be valid RationsType enum value
- `id`: Must be unique across all custom aliments
- `createdAt`: Must be valid Date, auto-set
- `updatedAt`: If set, must be >= createdAt

**Business Rules**:
- Custom aliments are user-specific (no sharing in v1)
- Duplicate names allowed (users may have regional variants)
- Soft delete not implemented (hard delete only)
- No audit trail (single version, no history)

---

### CreateCustomAlimentDTO

Data transfer object for creating new custom aliments. Omits auto-generated fields.

```typescript
type CreateCustomAlimentDTO = Omit<
  CustomAliment,
  'id' | 'createdAt' | 'isCustom' | 'updatedAt'
>;

// Equivalent to:
// {
//   name: string;
//   type: RationsType;
//   gramsToCarbohydrate: number;
//   bloodGlucoseIndex?: number;
// }
```

**Usage**: Passed to `repository.save()` method

---

### UpdateCustomAlimentDTO

Data transfer object for updating existing custom aliments. All fields optional except ID.

```typescript
interface UpdateCustomAlimentDTO {
  id: string;              // Required: Which aliment to update
  name?: string;
  type?: RationsType;
  gramsToCarbohydrate?: number;
  bloodGlucoseIndex?: number;
}
```

**Usage**: Passed to `repository.update()` method

**Business Rule**: At least one optional field must be provided for update

---

## Relationships

### CustomAliment → RationsType

- **Type**: Composition (has-a)
- **Cardinality**: Many-to-One
- **Description**: Each custom aliment belongs to exactly one category (RationsType enum)

```
[CustomAliment] *----1 [RationsType]
```

**Navigation**:
- Forward: `customAliment.type` returns `RationsType`
- Reverse: Filter custom aliments by type via repository query

---

### CustomAliment ↔ AlimentInfo

- **Type**: Interface extension (is-a)
- **Cardinality**: N/A (structural typing)
- **Description**: CustomAliment extends AlimentInfo, adding persistence fields

```
[AlimentInfo] <|---- [CustomAliment]
```

**Type Compatibility**:
- `CustomAliment` can be used wherever `AlimentInfo` is expected
- Composite repository returns `AlimentInfo[]` containing both catalog and custom types
- Type guard: `'isCustom' in aliment && aliment.isCustom === true`

---

### CompositeAlimentRepository → Data Sources

- **Type**: Aggregation (uses)
- **Cardinality**: One-to-Many (1 composite → 2 sources)
- **Description**: Composite repository delegates to catalog and custom repositories

```
[CompositeAlimentRepository]
    |
    +---- uses ----> [InMemoryAlimentInfoRepository] (catalog, read-only)
    |
    +---- uses ----> [LocalStorageCustomAlimentRepository] (custom, CRUD)
```

**Data Flow**:
1. UI calls `compositeRepo.findAll()`
2. Composite delegates to both sources
3. Results merged and returned as `AlimentInfo[]`
4. UI renders without knowing source details

---

## State Transitions

### Custom Aliment Lifecycle

```
[Not Created] 
    |
    | user fills form
    | validation passes
    | repository.save()
    ↓
[Created] (id, createdAt set)
    |
    +---> user views/searches (read-only)
    |
    +---> user edits
    |     | repository.update()
    |     ↓
    |   [Updated] (updatedAt set)
    |     |
    |     +---> back to Created state
    |
    +---> user deletes
          | repository.delete()
          ↓
        [Deleted] (removed from storage)
```

**Transitions**:
1. **Creation**: Form submission → Validation → Save → Navigate to browser
2. **Update**: Edit form → Validation → Update → Navigate to details/browser
3. **Deletion**: Delete confirmation → Remove → Navigate to browser

**Invariants**:
- Once created, `id` and `createdAt` never change
- `updatedAt` only set on updates, always >= `createdAt`
- `isCustom` always `true` for Custom Aliments

---

## Data Storage

### localStorage Schema

**Key**: `sdd-rations-calculator:custom-aliments`

**Format**: JSON array of serialized CustomAliment objects

```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "Manzana ecológica",
    "type": "fruits",
    "gramsToCarbohydrate": 110,
    "bloodGlucoseIndex": 38,
    "createdAt": "2026-02-12T10:30:00.000Z",
    "isCustom": true
  },
  {
    "id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
    "name": "Pan de espelta",
    "type": "cereals_flours_pulses_legumes_tubers",
    "gramsToCarbohydrate": 22,
    "bloodGlucoseIndex": 45,
    "createdAt": "2026-02-12T11:45:00.000Z",
    "isCustom": true,
    "updatedAt": "2026-02-12T14:20:00.000Z"
  }
]
```

**Serialization**:
- Dates serialized as ISO 8601 strings (`Date.toISOString()`)
- Dates deserialized using `new Date(string)`
- Repository handles all serialization logic

**Quota Management**:
- Estimated size per aliment: ~200-300 bytes
- Target capacity: 100 custom aliments (~30KB)
- localStorage quota: 5-10MB (plenty headroom)
- Error handling: QuotaExceededError caught and user-friendly message shown

---

## Validation Summary

| Entity | Validation Location | Strategy |
|--------|-------------------|----------|
| **CreateCustomAlimentDTO** | UI form + Repository | Field-level in form, full validation before save |
| **UpdateCustomAlimentDTO** | UI form + Repository | Field-level in form, partial validation before update |
| **CustomAliment** | Repository only | Enforcement of invariants (id, createdAt immutable) |

**Validation Flow**:
1. **UI Layer**: Immediate field-level feedback during typing
2. **Form Submit**: Full form validation before calling repository
3. **Repository**: Final validation + business rule enforcement + uniqueness checks

---

## Migration Strategy

**Current State**: Aliment catalog exists (365+ items, read-only)

**Target State**: Catalog + custom aliments merged in UI

**Migration Steps**:
1. No data migration needed (new feature, no existing custom aliments)
2. localStorage key created on first custom aliment save
3. Empty array if key doesn't exist (backward compatible)
4. Catalog remains unchanged (immutable)

**Rollback**: Delete localStorage key removes all custom aliments, catalog unaffected

---

## Summary

- **Primary Entity**: CustomAliment (extends AlimentInfo)
- **DTOs**: CreateCustomAlimentDTO, UpdateCustomAlimentDTO
- **Storage**: localStorage JSON array, ~30KB for 100 items
- **Relationships**: Composition with RationsType, structural extension of AlimentInfo
- **Lifecycle**: Create → Update* → Delete
- **Validation**: Three-layer (UI, Form, Repository)

**Next Steps**: Define repository contracts in `contracts/` directory
